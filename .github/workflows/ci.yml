name: CI

on:
  push:
    branches: [ "master" ]  # Trigger only on direct pushes to master

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      - name: Build with Maven
        run: mvn clean install package

  update_parent_repo:
    runs-on: ubuntu-latest
    needs: build  # Ensure this runs only after the 'build' job is successful
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'  # Only run on direct pushes to master
    steps:
      - name: Capture commit hash
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)  # Get the commit hash of the current child repo commit
          echo "Commit hash: $COMMIT_HASH"
          echo "COMMIT_HASH=${COMMIT_HASH}" >> $GITHUB_ENV  # Save it as an environment variable

      - name: Trigger parent repo to update submodule
        run: |
          curl -X POST https://api.github.com/repos/aistomin/andy.grails/dispatches \
          -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "event_type": "update_backend_rev", 
            "client_payload": {
              "brev": "${{ env.COMMIT_HASH }}",  # Pass the commit hash from the environment
              "ref": "refs/heads/master"
            }
          }'
